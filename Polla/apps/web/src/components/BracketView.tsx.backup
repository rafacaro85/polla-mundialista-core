"use client";

import React, { useState, useEffect } from 'react';
import { Trophy, Save, Check } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { api } from '@/lib/api';

interface Match {
    id: string;
    homeTeam: string;
    awayTeam: string;
    homeScore?: number | null;
    awayScore?: number | null;
    phase?: string;
    homeTeamPlaceholder?: string;
    awayTeamPlaceholder?: string;
    homeFlag?: string;
    awayFlag?: string;
    dateStr: string;
    bracketId?: number;
    status?: string;
    date?: string;
}

interface BracketViewProps {
    matches: Match[];
}

interface Team {
    name: string;
    flag?: string;
}

const PHASE_POINTS = {
    'ROUND_16': 3,
    'QUARTER': 6,
    'SEMI': 10,
    'FINAL': 20,
};

export function BracketView({ matches }: BracketViewProps) {
    const [picks, setPicks] = useState<Record<string, string>>({});
    const [bracketPoints, setBracketPoints] = useState(0);
    const [loading, setLoading] = useState(true);

    // Cargar bracket guardado desde la API
    useEffect(() => {
        const loadBracket = async () => {
            try {
                const { data } = await api.get('/brackets/my');
                if (data) {
                    setPicks(data.picks || {});
                    setBracketPoints(data.points || 0);
                }
            } catch (e) {
                console.error('Error loading bracket:', e);
            } finally {
                setLoading(false);
            }
        };
        loadBracket();
    }, []);

    // Filtrar solo Octavos (partidos reales de la API)
    const round16 = matches
        .filter(m => m.phase === 'ROUND_16')
        .sort((a, b) => (a.bracketId || 0) - (b.bracketId || 0));

    // Funci√≥n para obtener el equipo ganador de un partido REAL
    const getWinnerFromMatch = (match: Match): Team | null => {
        // Si hay una selecci√≥n del usuario
        if (picks[match.id]) {
            const selectedTeam = picks[match.id];
            if (selectedTeam === match.homeTeam) {
                return { name: match.homeTeam, flag: match.homeFlag };
            } else if (selectedTeam === match.awayTeam) {
                return { name: match.awayTeam, flag: match.awayFlag };
            }
        }

        // Si el partido est√° finalizado, determinar ganador por marcador
        if (match.status === 'FINISHED' && match.homeScore !== null && match.awayScore !== null) {
            if (match.homeScore > match.awayScore) {
                return { name: match.homeTeam, flag: match.homeFlag };
            } else if (match.awayScore > match.homeScore) {
                return { name: match.awayTeam, flag: match.awayFlag };
            }
        }

        return null;
    };

    // Funci√≥n para obtener ganador de partido VIRTUAL
    const getWinnerFromVirtual = (virtualMatchId: string, home: Team | null, away: Team | null): Team | null => {
        if (!picks[virtualMatchId] || !home || !away) return null;

        const selectedTeam = picks[virtualMatchId];
        if (selectedTeam === home.name) return home;
        if (selectedTeam === away.name) return away;

        return null;
    };

    // Derivar partidos de Cuartos de Final (virtuales)
    const deriveQuarters = (): Array<{ home: Team | null, away: Team | null, id: string }> => {
        return [
            {
                id: 'quarter-1',
                home: round16[0] ? getWinnerFromMatch(round16[0]) : null,
                away: round16[1] ? getWinnerFromMatch(round16[1]) : null
            },
            {
                id: 'quarter-2',
                home: round16[2] ? getWinnerFromMatch(round16[2]) : null,
                away: round16[3] ? getWinnerFromMatch(round16[3]) : null
            },
            {
                id: 'quarter-3',
                home: round16[4] ? getWinnerFromMatch(round16[4]) : null,
                away: round16[5] ? getWinnerFromMatch(round16[5]) : null
            },
            {
                id: 'quarter-4',
                home: round16[6] ? getWinnerFromMatch(round16[6]) : null,
                away: round16[7] ? getWinnerFromMatch(round16[7]) : null
            }
        ];
    };

    // Derivar partidos de Semifinales (virtuales)
    const deriveSemis = (): Array<{ home: Team | null, away: Team | null, id: string }> => {
        const quarters = deriveQuarters();
        return [
            {
                id: 'semi-1',
                home: getWinnerFromVirtual(quarters[0].id, quarters[0].home, quarters[0].away),
                away: getWinnerFromVirtual(quarters[1].id, quarters[1].home, quarters[1].away)
            },
            {
                id: 'semi-2',
                home: getWinnerFromVirtual(quarters[2].id, quarters[2].home, quarters[2].away),
                away: getWinnerFromVirtual(quarters[3].id, quarters[3].home, quarters[3].away)
            }
        ];
    };

    // Derivar Final (virtual)
    const deriveFinal = (): { home: Team | null, away: Team | null, id: string } => {
        const semis = deriveSemis();
        return {
            id: 'final',
            home: getWinnerFromVirtual(semis[0].id, semis[0].home, semis[0].away),
            away: getWinnerFromVirtual(semis[1].id, semis[1].home, semis[1].away)
        };
    };

    // Verificar si el usuario acert√≥ la predicci√≥n
    const didUserGetItRight = (match: Match): boolean => {
        if (match.status !== 'FINISHED' || !picks[match.id]) return false;
        if (match.homeScore === null || match.awayScore === null) return false;

        const actualWinner = match.homeScore > match.awayScore ? match.homeTeam : match.awayTeam;
        return picks[match.id] === actualWinner;
    };

    // Manejar selecci√≥n de equipo
    const handleTeamSelect = (matchId: string, teamName: string) => {
        console.log('üéØ Team selected:', { matchId, teamName });
        setPicks(prev => {
            const newPicks = {
                ...prev,
                [matchId]: teamName
            };
            console.log('üìä Updated picks:', newPicks);
            return newPicks;
        });
        toast.success(`${teamName} seleccionado`, {
            duration: 1000,
            icon: '‚öΩ'
        });
    };

    // Guardar bracket en la API
    const handleSaveBracket = async () => {
        try {
            const { data } = await api.post('/brackets', { picks });
            setBracketPoints(data.points || 0);
            toast.success('Bracket guardado exitosamente! üèÜ', {
                description: `${Object.keys(picks).length} predicciones guardadas`,
                duration: 3000
            });
        } catch (e) {
            console.error('Error saving bracket:', e);
            toast.error('Error al guardar bracket');
        }
    };

    // Limpiar bracket
    const handleClearBracket = async () => {
        const confirmed = window.confirm(
            '¬øEst√°s seguro de que quieres limpiar todo tu bracket?\n\n' +
            'Esta acci√≥n eliminar√° todas tus predicciones y puntos acumulados.\n\n' +
            'Esta acci√≥n NO se puede deshacer.'
        );

        if (!confirmed) return;

        try {
            await api.delete('/brackets/me');
            setPicks({});
            setBracketPoints(0);
            toast.info('Bracket reiniciado exitosamente', {
                description: 'Puedes empezar de nuevo',
                duration: 3000
            });
        } catch (e) {
            console.error('Error clearing bracket:', e);
            toast.error('Error al limpiar bracket');
        }
    };

    // Componente de Tarjeta de Partido
    const MatchCard = ({
        match,
        virtualMatch,
        matchId
    }: {
        match?: Match;
        virtualMatch?: { home: Team | null, away: Team | null, id: string };
        matchId: string;
    }) => {
        const isReal = !!match;
        // Mostrar placeholder si el equipo est√° vac√≠o, sino mostrar el nombre del equipo
        const homeTeam = isReal
            ? (match.homeTeam || match.homeTeamPlaceholder || 'TBD')
            : (virtualMatch?.home?.name || 'TBD');
        const awayTeam = isReal
            ? (match.awayTeam || match.awayTeamPlaceholder || 'TBD')
            : (virtualMatch?.away?.name || 'TBD');
        const homeFlag = isReal ? match?.homeFlag : virtualMatch?.home?.flag;
        const awayFlag = isReal ? match?.awayFlag : virtualMatch?.away?.flag;

        const homeSelected = picks[matchId] === homeTeam;
        const awaySelected = picks[matchId] === awayTeam;

        const canSelect = homeTeam !== 'TBD' && awayTeam !== 'TBD' && (!isReal || match.status !== 'FINISHED');

        // Verificar si acert√≥ (solo para partidos reales finalizados)
        const userGotItRight = isReal && match ? didUserGetItRight(match) : false;
        const pointsEarned = userGotItRight && match?.phase ? PHASE_POINTS[match.phase as keyof typeof PHASE_POINTS] : 0;

        return (
            <div className="relative">
                {/* Badge de puntos ganados */}
                {userGotItRight && pointsEarned > 0 && (
                    <div className="absolute -top-2 -right-2 bg-green-500 rounded-full px-2 py-1 flex items-center gap-1 z-10 shadow-lg">
                        <Check className="w-3 h-3 text-white" />
                        <span className="text-xs text-white font-bold">+{pointsEarned}pts</span>
                    </div>
                )}

                <div className={`bg-obsidian border rounded-lg p-3 w-56 hover:border-slate-500 transition-all ${userGotItRight ? 'border-green-500 shadow-lg shadow-green-500/20' : 'border-slate-700'
                    };

    const quarters = deriveQuarters();
    const semis = deriveSemis();
    const final = deriveFinal();
    const champion = getWinnerFromVirtual('final', final.home, final.away);

    if (loading) {
        return (
            <div className="flex items-center justify-center p-8">
                <p className="text-tactical">Cargando bracket...</p>
            </div>
        );
    }

    return (
        <div className="w-full relative">
            {/* Header con contador de puntos */}
            <div className="mb-6">
                <div className="flex items-center justify-between mb-4">
                    <div>
                        <h2 className="text-2xl font-russo text-white mb-2">LLAVES DEL TORNEO</h2>
                        <p className="text-tactical text-sm">
                            Haz clic en los equipos para seleccionar ganadores. Los equipos avanzan autom√°ticamente.
                        </p>
                    </div>
                    <div className="flex items-center gap-4">
                        {bracketPoints > 0 && (
                            <div className="bg-signal/20 border-2 border-signal rounded-lg px-6 py-3">
                                <p className="text-xs text-tactical uppercase tracking-wide">Puntos de Bracket</p>
                                <p className="text-3xl font-russo text-signal">{bracketPoints}</p>
                            </div>
                        )}
                        {/* Botones de acci√≥n */}
                        <div className="flex flex-col gap-2">
                            <Button
                                onClick={handleSaveBracket}
                                className="bg-signal hover:bg-signal/90 text-obsidian font-bold shadow-lg shadow-signal/40"
                                size="sm"
                                disabled={Object.keys(picks).length === 0}
                            >
                                <Save className="w-4 h-4 mr-2" />
                                üíæ Guardar ({Object.keys(picks).length})
                            </Button>
                            <Button
                                onClick={handleClearBracket}
                                variant="destructive"
                                className="bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg shadow-red-600/40"
                                size="sm"
                                disabled={Object.keys(picks).length === 0}
                            >
                                üóëÔ∏è Limpiar
                            </Button>
                        </div>
                    </div>
                </div>
            </div>

            {/* Bracket Container con Scroll Horizontal */}
            <div className="overflow-x-auto pb-8">
                <div className="inline-flex gap-8 min-w-max px-4">
                    {/* Columna 1: Octavos de Final (Partidos Reales) */}
                    <div className="flex flex-col gap-4">
                        <h3 className="text-center font-russo text-signal mb-2 sticky top-0 bg-obsidian z-10">
                            OCTAVOS
                        </h3>
                        {round16.length > 0 ? (
                            round16.map((match) => (
                                <MatchCard key={match.id} match={match} matchId={match.id} />
                            ))
                        ) : (
                            <p className="text-tactical text-sm">No hay partidos de octavos</p>
                        )}
                    </div>

                    {/* Columna 2: Cuartos de Final (Virtuales) */}
                    <div className="flex flex-col gap-8 justify-around">
                        <h3 className="text-center font-russo text-signal mb-2 sticky top-0 bg-obsidian z-10">
                            CUARTOS
                        </h3>
                        {quarters.map((quarter) => (
                            <MatchCard key={quarter.id} virtualMatch={quarter} matchId={quarter.id} />
                        ))}
                    </div>

                    {/* Columna 3: Semifinales (Virtuales) */}
                    <div className="flex flex-col gap-16 justify-around">
                        <h3 className="text-center font-russo text-signal mb-2 sticky top-0 bg-obsidian z-10">
                            SEMIFINALES
                        </h3>
                        {semis.map((semi) => (
                            <MatchCard key={semi.id} virtualMatch={semi} matchId={semi.id} />
                        ))}
                    </div>

                    {/* Columna 4: Final (Virtual) */}
                    <div className="flex flex-col justify-center">
                        <h3 className="text-center font-russo text-signal mb-4 sticky top-0 bg-obsidian z-10">
                            FINAL
                        </h3>
                        <MatchCard virtualMatch={final} matchId={final.id} />
                    </div>

                    {/* Columna 5: Campe√≥n */}
                    <div className="flex flex-col justify-center items-center min-w-[200px]">
                        <Trophy className="w-16 h-16 text-signal mb-4" />
                        <p className="text-center font-russo text-signal text-xl mb-4">CAMPE√ìN</p>
                        {champion ? (
                            <div className="p-4 bg-signal/20 border-2 border-signal rounded-lg">
                                {champion.flag && (
                                    <img
                                        src={champion.flag}
                                        alt=""
                                        className="w-12 h-8 object-cover rounded-sm mx-auto mb-2"
                                    />
                                )}
                                <p className="text-white font-bold text-lg text-center">
                                    {champion.name}
                                </p>
                            </div>
                        ) : (
                            <div className="p-4 bg-slate-800/50 border border-slate-700 rounded-lg">
                                <p className="text-slate-500 italic text-center">TBD</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Leyenda */}
            <div className="mt-6 p-4 bg-obsidian/50 rounded-lg border border-slate-700/50">
                <div className="flex flex-wrap gap-4 justify-center text-xs text-tactical">
                    <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-signal/20 border border-signal"></div>
                        <span>Seleccionado</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span>Acertado</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-slate-800 border border-slate-700"></div>
                        <span>Disponible</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-slate-900 border border-slate-800 opacity-60"></div>
                        <span>TBD (Pendiente)</span>
                    </div>
                </div>
            </div>
        </div>
    );
}
